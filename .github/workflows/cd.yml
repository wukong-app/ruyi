name: CD For Ruyi

on:
  push:
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'
      - 'v[0-9]*.[0-9]*.[0-9]*-dev*'
  workflow_dispatch:

jobs:
  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    outputs:
      release_tag: ${{ steps.release_info.outputs.tag_name }}
      is_prerelease: ${{ steps.release_info.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Tag Format
        run: |
          TAG=${{ github.ref_name }}
          echo "Verifying tag: $TAG"
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Valid Release Tag"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-dev.*$ ]]; then
            echo "Valid Pre-release Tag"
          else
            echo "Error: Invalid tag format. Only vX.Y.Z or vX.Y.Z-dev* are allowed."
            exit 1
          fi

      - name: Determine Release Info
        id: release_info
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "Tag: $TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          if [[ "$TAG_NAME" == *"-dev"* ]]; then
            echo "Detected Pre-release (Dev)"
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            export TZ='Asia/Shanghai'
            TITLE=$(date +'v%Y%m%d%H%M')
            echo "title=$TITLE" >> $GITHUB_OUTPUT
            echo "release_type=Pre-release" >> $GITHUB_OUTPUT
          else
            echo "Detected Formal Release"
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "title=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "release_type=Release" >> $GITHUB_OUTPUT
          fi

      - name: Generate Issue List
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Generating issue list..."
          
          LAST_RELEASE=$(gh release list --repo ${{ github.repository }} --exclude-pre-releases --exclude-drafts --limit 1 --json tagName,publishedAt)
          
          if [ -z "$LAST_RELEASE" ] || [ "$LAST_RELEASE" == "[]" ]; then
            LAST_DATE=""
            echo "No previous release found. Searching all closed issues."
          else
            LAST_TAG=$(echo "$LAST_RELEASE" | jq -r '.[0].tagName')
            LAST_DATE=$(echo "$LAST_RELEASE" | jq -r '.[0].publishedAt')
            echo "Last release: $LAST_TAG ($LAST_DATE)"
          fi
          
          OUTPUT_FILE="issue_list.md"
          echo "" > $OUTPUT_FILE
          
          LABELS=("enhancement" "bug" "refactor")
          TITLES=("### Enhancement" "### Bug Fixes" "### Refactoring")
          
          for i in "${!LABELS[@]}"; do
             LABEL="${LABELS[$i]}"
             TITLE="${TITLES[$i]}"
             
             echo "Processing label: $LABEL"
             
             QUERY="repo:${{ github.repository }} type:issue state:closed label:$LABEL"
             
             if [ ! -z "$LAST_DATE" ] && [ "$LAST_DATE" != "null" ]; then
                QUERY="$QUERY closed:>$LAST_DATE"
             fi
             
             echo "Running: gh search issues $QUERY"
             
             ISSUES=$(gh search issues $QUERY --limit 100 --json title,url,number --template '{{range .}}- [{{.title}}]({{.url}}) #{{.number}}{{ "\n" }}{{end}}')
             
             if [ ! -z "$ISSUES" ]; then
                echo "$TITLE" >> $OUTPUT_FILE
                echo "$ISSUES" >> $OUTPUT_FILE
                echo "" >> $OUTPUT_FILE
             fi
          done
          
          {
            echo "content<<EOF"
            cat $OUTPUT_FILE
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: ${{ steps.release_info.outputs.title }}
          body: |
            ## Ruyi ${{ steps.release_info.outputs.release_type }} ${{ steps.release_info.outputs.title }}
            
            This is an automated build triggered by tag `${{ github.ref_name }}`.
            
            ${{ steps.changelog.outputs.content }}
            
            > Generated by GitHub Actions CD Workflow
          prerelease: ${{ steps.release_info.outputs.is_prerelease }}
          draft: false

  build:
    name: ${{ matrix.config.name }}
    needs: create_release
    runs-on: ${{ matrix.config.os }}
    defaults:
      run:
        shell: bash
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: Build macOS (amd64)
            os: macos-latest
            goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - name: Build macOS (arm64)
            os: macos-latest
            goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - name: Build Linux (amd64)
            os: ubuntu-latest
            goos: linux
            goarch: amd64
            suffix: linux-amd64
          - name: Build Windows (amd64)
            os: windows-latest
            goos: windows
            goarch: amd64
            suffix: windows-amd64.exe
            
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Go version from go.mod
        id: go-version
        run: |
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "Detected Go version: $GO_VERSION"
          echo "version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.go-version.outputs.version }}

      - name: Build
        env:
          GOOS: ${{ matrix.config.goos }}
          GOARCH: ${{ matrix.config.goarch }}
          CGO_ENABLED: 1
        run: |
          # Ensure dependencies and wire code are ready
          go mod tidy
          
          # Generate wire code
          # We use explicit command instead of make to avoid dependency on make tool in Windows
          cd internal
          go run -mod=mod github.com/google/wire/cmd/wire
          cd ..
          
          mkdir -p output/ruyi
          OUT_FILE="output/ruyi/ruyi-${{ matrix.config.suffix }}"
          
          echo "Building for $GOOS/$GOARCH..."
          
          # Common ldflags for release builds:
          # -s: Omit the symbol table and debug information
          # -w: Omit the DWARF symbol table
          LDFLAGS="-s -w"
          
          # Use -static flag to avoid dependency on MinGW DLLs (libgcc, libstdc++, libwinpthread)
          if [ "$GOOS" == "windows" ]; then
             go build -ldflags "$LDFLAGS -extldflags '-static -static-libgcc -static-libstdc++'" -o $OUT_FILE cmd/ruyi/main.go
          else
             go build -ldflags "$LDFLAGS" -o $OUT_FILE cmd/ruyi/main.go
          fi
          
          echo "artifact_path=$OUT_FILE" >> $GITHUB_OUTPUT

      - name: Upload Release Asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.create_release.outputs.release_tag }}
        run: |
          echo "Uploading asset to release $TAG_NAME..."
          gh release upload $TAG_NAME output/ruyi/ruyi-${{ matrix.config.suffix }}
