name: CD For Ruyi

on:
  push:
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'
      - 'v[0-9]*.[0-9]*.[0-9]*-dev*'
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Tag Format
        run: |
          TAG=${{ github.ref_name }}
          echo "Verifying tag: $TAG"
          # Strict Regex Validation
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Valid Release Tag"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-dev.*$ ]]; then
            echo "Valid Pre-release Tag"
          else
            echo "Error: Invalid tag format. Only vX.Y.Z or vX.Y.Z-dev* are allowed."
            exit 1
          fi

      - name: Get Go version from go.mod
        id: go-version
        run: |
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "Detected Go version: $GO_VERSION"
          echo "version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.go-version.outputs.version }}

      - name: Build
        run: make build

      - name: Determine Release Info
        id: release_info
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "Tag: $TAG_NAME"
          
          if [[ "$TAG_NAME" == *"-dev"* ]]; then
            echo "Detected Pre-release (Dev)"
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            export TZ='Asia/Shanghai'
            TITLE=$(date +'v%Y%m%d%H%M')
            echo "title=$TITLE" >> $GITHUB_OUTPUT
            echo "release_type=Pre-release" >> $GITHUB_OUTPUT
          else
            echo "Detected Formal Release"
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "title=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "release_type=Release" >> $GITHUB_OUTPUT
          fi

      - name: Generate Issue List
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Generating issue list..."
          
          # Get last formal release
          LAST_RELEASE=$(gh release list --repo ${{ github.repository }} --exclude-pre-releases --exclude-drafts --limit 1 --json tagName,publishedAt)
          
          if [ -z "$LAST_RELEASE" ] || [ "$LAST_RELEASE" == "[]" ]; then
            LAST_DATE=""
            echo "No previous release found. Searching all closed issues."
          else
            LAST_TAG=$(echo "$LAST_RELEASE" | jq -r '.[0].tagName')
            LAST_DATE=$(echo "$LAST_RELEASE" | jq -r '.[0].publishedAt')
            echo "Last release: $LAST_TAG ($LAST_DATE)"
          fi
          
          OUTPUT_FILE="issue_list.md"
          echo "" > $OUTPUT_FILE
          
          # Define labels and titles
          LABELS=("enhancement" "bug" "refactor")
          TITLES=("### Enhancement" "### Bug Fixes" "### Refactoring")
          
          for i in "${!LABELS[@]}"; do
             LABEL="${LABELS[$i]}"
             TITLE="${TITLES[$i]}"
             
             echo "Processing label: $LABEL"
             
             # Build query
             QUERY="repo:${{ github.repository }} type:issue state:closed label:$LABEL"
             
             if [ ! -z "$LAST_DATE" ] && [ "$LAST_DATE" != "null" ]; then
                QUERY="$QUERY closed:>$LAST_DATE"
             fi
             
             # Fetch issues
             ISSUES=$(gh search issues "$QUERY" --limit 100 --json title,url,number --template '{{range .}}- [{{.title}}]({{.url}}) #{{.number}}{{ "\n" }}{{end}}')
             
             if [ ! -z "$ISSUES" ]; then
                echo "$TITLE" >> $OUTPUT_FILE
                echo "$ISSUES" >> $OUTPUT_FILE
                echo "" >> $OUTPUT_FILE
             fi
          done
          
          # Read file content into GITHUB_OUTPUT (multiline)
          {
            echo "content<<EOF"
            cat $OUTPUT_FILE
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: ${{ steps.release_info.outputs.title }}
          body: |
            ## Ruyi ${{ steps.release_info.outputs.release_type }} ${{ steps.release_info.outputs.title }}
            
            This is an automated build triggered by tag `${{ github.ref_name }}`.
            
            ${{ steps.changelog.outputs.content }}
            
            > Generated by GitHub Actions CD Workflow
          files: output/ruyi/ruyi
          prerelease: ${{ steps.release_info.outputs.is_prerelease }}
          draft: false
