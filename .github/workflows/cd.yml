name: CD For Ruyi

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Go version from go.mod
        id: go-version
        run: |
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "Detected Go version: $GO_VERSION"
          echo "version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.go-version.outputs.version }}

      - name: Build
        run: make build

      - name: Determine Release Info
        id: release_info
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "Tag: $TAG_NAME"
          
          # Check if tag contains '-dev'
          if [[ "$TAG_NAME" == *"-dev"* ]]; then
            echo "Detected Pre-release (Dev)"
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            
            # Generate timestamp title for dev builds
            export TZ='Asia/Shanghai'
            TITLE=$(date +'v%Y%m%d%H%M')
            echo "title=$TITLE" >> $GITHUB_OUTPUT
            echo "release_type=Pre-release" >> $GITHUB_OUTPUT
          else
            echo "Detected Formal Release"
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            
            # Use tag name as title for formal releases
            echo "title=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "release_type=Release" >> $GITHUB_OUTPUT
          fi

      - name: Generate Issue List
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Generating issue list..."
          
          # Get last formal release
          LAST_RELEASE=$(gh release list --repo ${{ github.repository }} --exclude-pre-releases --exclude-drafts --limit 1 --json tagName,publishedAt)
          
          if [ -z "$LAST_RELEASE" ] || [ "$LAST_RELEASE" == "[]" ]; then
            LAST_DATE=""
            LAST_TAG=""
          else
            LAST_TAG=$(echo "$LAST_RELEASE" | jq -r '.[0].tagName')
            LAST_DATE=$(echo "$LAST_RELEASE" | jq -r '.[0].publishedAt')
          fi
          
          OUTPUT_FILE="issue_list.md"
          echo "### Completed Issues" > $OUTPUT_FILE
          
          if [ -z "$LAST_DATE" ] || [ "$LAST_DATE" == "null" ]; then
             echo "> No previous formal release found. Listing recent closed issues." >> $OUTPUT_FILE
             gh issue list --repo ${{ github.repository }} --state closed --limit 50 --json title,url,number --template '{{range .}}- [{{.title}}]({{.url}}) #{{.number}}{{ "\n" }}{{end}}' >> $OUTPUT_FILE
          else
             echo "> Since last formal release **$LAST_TAG** ($LAST_DATE)" >> $OUTPUT_FILE
             # Search closed issues > LAST_DATE
             gh search issues --repo ${{ github.repository }} --type issue --state closed --closed ">$LAST_DATE" --limit 100 --json title,url,number --template '{{range .}}- [{{.title}}]({{.url}}) #{{.number}}{{ "\n" }}{{end}}' >> $OUTPUT_FILE
          fi
          
          # Read file content into GITHUB_OUTPUT (multiline)
          {
            echo "content<<EOF"
            cat $OUTPUT_FILE
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: ${{ steps.release_info.outputs.title }}
          body: |
            ## Ruyi ${{ steps.release_info.outputs.release_type }} ${{ steps.release_info.outputs.title }}
            
            This is an automated build triggered by tag `${{ github.ref_name }}`.
            
            ### Build Details
            - **Type:** ${{ steps.release_info.outputs.release_type }}
            - **Tag:** `${{ github.ref_name }}`
            - **Commit:** `${{ github.sha }}`
            - **Go Version:** `${{ steps.go-version.outputs.version }}`
            
            ${{ steps.changelog.outputs.content }}
            
            > Generated by GitHub Actions CD Workflow
          files: output/ruyi/ruyi
          prerelease: ${{ steps.release_info.outputs.is_prerelease }}
          draft: false
